# Audit of Nutri‑GPT Assistant Backend (GitHub: `nutri-gpt-assistant`)

## Feature Implementation vs. Plan Requirements

| **Planned Feature (v2.1 & v3)Implementation Status**                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Auth & Tiered Access** – JWT auth middleware with roles for Free/Limited/Unlimited plans (and admin) | **Partially implemented.** A JWT-based auth middleware is in place[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/auth.js#L4-L12). It verifies bearer tokens and attaches `req.user` (with `id` and `plan` claims). The code checks `req.user.plan` for `"unlimited"` to bypass quotas[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L5-L13)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L14-L22). However, **no explicit admin role check** is implemented – endpoints meant for admins (dataset upload, settings update) are only protected by regular login auth (any user token can call them) and not restricted to an admin user, which deviates from the plan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Quota & Credits** – Per-user `remainingCredits` tracked, decrement on chat unless plan is unlimited  | **Implemented.** The database schema added a `remaining_credits` field to users and a Postgres function `decrement_credit(uid)`[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/db/migrations/20250730_r1.sql#L2-L10)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/db/migrations/20250730_r1.sql#L26-L35). A `quota` middleware checks the user’s remaining credits via Supabase on each request and calls the RPC to decrement it[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L9-L18)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L19-L23). If credits are 0, it returns `403 QUOTA_EXCEEDED`[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L14-L22). Unlimited-plan users skip the credit check/deduction entirely[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/middleware/quota.js#L5-L12). **Gap:** The JWT token itself is not reissued with updated credits – the system always queries the DB for current credits, which is fine, but the plan’s idea of embedding `remainingCredits` in JWT is not realized.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Stripe Billing Webhook** – Handle subscription checkout events to upgrade user plan & credits        | **Partially implemented.** A Stripe webhook endpoint exists (`POST /api/billing/webhook`) to process `checkout.session.completed` events[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/billing.js#L12-L20). It reads `event.data.object.customer` (Stripe customer ID) and `metadata.plan` (“limited” or “unlimited”) from the Stripe event[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/billing.js#L19-L26). It then updates the user’s `plan` and sets `remaining_credits` (1000 for limited, `null` for unlimited) where `stripe_customer` matches the event’s customer ID[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/billing.js#L19-L27). This covers applying the purchased plan. **Gaps:** There is no code to create Stripe checkout sessions or to ensure each user’s `stripe_customer` ID is set in the database – presumably this must be handled elsewhere or manually. Also, the webhook blindly overwrites credits (e.g. resets to 1000 for limited) rather than accumulating; repeated purchases or subscription renewals might not increment credits. The code doesn’t handle other Stripe events (e.g. subscription renewal invoices) beyond ignoring non-checkout events[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/billing.test.js#L101-L108)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/billing.test.js#L109-L116).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Dataset File Upload to Supabase** – Admin-upload of reference data files (with 10 MB size cap)       | **Mostly implemented (user-scoped, missing size check).** There is an endpoint `POST /api/datasets/upload` that saves a file to a Supabase Storage bucket and records it in a `datasets` table[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L26-L35)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L43-L51). It expects a `filename` and base64 `fileData` in the request body[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L14-L22), and it stores the file under a path namespaced by the user’s ID, then inserts a DB record[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L22-L30)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L43-L51). The response returns the new dataset’s ID, filename, URL, and timestamp[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L54-L63). **Gaps:** The plan’s 10 MB file size guard is **not enforced** – there’s no check on `fileData` length, so a large upload could exhaust memory or storage. Also, this endpoint is not restricted to admins; any authenticated user can upload (the code does require auth and even applies the quota middleware[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L13-L21), meaning uploads consume a credit, though the plan didn’t specify that). There is no validation of file content (only filename and data presence).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Assistant Settings Persistence** – Save & retrieve configurable prompts (strict/creative) and params | **Implemented (per-user instead of global).** The app provides `GET/PUT/PATCH/DELETE /api/assistant/settings` endpoints (mounted at `/api/assistant/settings` and requiring auth)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/server.js#L25-L27)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L12-L20)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L43-L51)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L81-L89)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L109-L117). These use a Supabase table `assistant_settings` (keyed by user) to store each user’s custom `strict_prompt`, `creative_prompt`, task lists, and temperature settings[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/db/migrations/20250730_r1.sql#L14-L23). On GET, if no record exists for that user, default values (null or presets) are returned[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L25-L34). PUT upserts the settings for the user (inserting or updating the row)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L64-L73), PATCH updates specific fields, and DELETE resets (deletes the row)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L110-L119). **Deviation from plan:** In the roadmap v3, these settings were envisioned as **admin-managed global prompts**. The implementation instead treats them as user-specific preferences (each user can have their own custom prompts), and no admin check is required to modify them. This is a functional choice difference, but not necessarily a bug – it adds flexibility, though it means there’s no single “global” prompt repository as originally described.                                                                                                                                                                                                                                                                                                                                                                                  |
| **Centralized Error Handling** – Uniform error responses and logging                                   | **Implemented.** A catch-all error middleware is registered last in the Express app to log the error and return HTTP 500 with a JSON error message[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/server.js#L29-L33). In practice, many routes also have their own `try/catch`. For example, the chat route catches exceptions and returns an `'UPSTREAM_ERROR'` for OpenAI failures[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/chat.js#L46-L55), and other routes return generic `{ error: "Internal server error" }` on exceptions[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/datasets.js#L66-L73)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/routes/settings.js#L76-L84). All unhandled errors would flow into the central handler (which uses a generic `"INTERNAL_SERVER_ERROR"` message)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/server/server.js#L29-L33). Logging is done via `console.error` in both the route catches and central handler. This satisfies basic stability requirements, though there is no more granular error differentiation beyond the codes above, and no external logging service integration.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Unit Tests & Coverage** – Automated tests for auth, quota, upload, billing, settings, etc.           | **Partially implemented.** The repository includes a test suite using Jest (`/tests/` directory). There are tests covering the chat endpoint behavior (modes, JSON vs. text output, allergen guard, missing fields)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/chat.test.js#L36-L45)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/chat.test.js#L88-L96)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/chat.test.js#L159-L168), the quota middleware (credits allowed vs. exhausted vs. unlimited)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/quota.test.js#L56-L64)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/quota.test.js#L70-L79)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/quota.test.js#L81-L89), the settings routes (get defaults vs. existing, create/update settings)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/settings.test.js#L81-L90)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/settings.test.js#L116-L125), and the Stripe webhook (valid vs. invalid signatures and event types)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/billing.test.js#L63-L71)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/billing.test.js#L101-L108). These tests confirm that core logic works as expected (e.g. returning 422 on allergen conflict[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/chat.test.js#L98-L106)[GitHub](https://github.com/nutri-org/nutri-gpt-assistant/blob/e5bb499f52e6ab9179aa8aa5b305e52572740b42/tests/chat.test.js#L112-L116), 403 on no credits, etc.). **Gaps:** Tests for the dataset upload route were not found – the upload functionality might not have dedicated test coverage, which is a notable omission given its complexity. Also, no standalone tests for the auth middleware (e.g. ensuring `auth(false)` allows through when token missing) are present, though auth is indirectly exercised in other tests via requiring a valid token. Overall unit test coverage is decent for chat/quota/settings/billing, but a few endpoints are untested. |
